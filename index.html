<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slack Channel Data</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid black;
            padding: 8px;
            text-align: left;
        }
        pre {
            white-space: pre-wrap;       /* Since CSS 2.1 */
            white-space: -moz-pre-wrap;  /* Mozilla, since 1999 */
            white-space: -pre-wrap;      /* Opera 4-6 */
            white-space: -o-pre-wrap;    /* Opera 7 */
            word-wrap: break-word;       /* Internet Explorer 5.5+ */
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Slack Channel Data</h1>
        <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">Upload ZIP File</button>
        <input type="file" id="fileInput" accept=".zip" style="display:none;">
        <table id="dataTable" class="table table-striped">
            <thead>
                <tr>
                    <th>Channel Name</th>
                    <th>Number of Messages</th>
                    <th>Message Count</th>
                    <th>Merged</th>
                    <th>Closed</th>
                    <th>Actual Reflections</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
        <div id="accordion" class="accordion"></div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/jszip/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.getElementById('fileInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                JSZip.loadAsync(file).then(function(zip) {
                    const channels = {};
                    const userIdToName = {};
                    const promises = [];

                    // Collect user info if users.json exists
                    if (zip.file("users.json")) {
                        const usersPromise = zip.file("users.json").async("string").then(function(content) {
                            const users = JSON.parse(content);
                            users.forEach(user => {
                                if (user.id && user.name) {
                                    userIdToName[user.id] = user.name;
                                }
                            });
                        });
                        promises.push(usersPromise);
                    }

                    zip.forEach(function (relativePath, zipEntry) {
                        if (zipEntry.dir) return; // Skip directories
                        if (relativePath.endsWith('.json') && relativePath !== "users.json") {
                            const promise = zipEntry.async("string").then(function(content) {
                                const messages = JSON.parse(content);
                                const channelName = relativePath.split('/')[0];
                                if (!channels[channelName]) {
                                    channels[channelName] = {
                                        messageCount: 0,
                                        users: {},
                                        mergedCount: 0,
                                        closedCount: 0,
                                        reflectionCount: 0,
                                        logs: []
                                    };
                                }
                                channels[channelName].logs.push({file: relativePath, content: messages});
                                messages.forEach(message => {
                                    channels[channelName].messageCount++;
                                    const userId = message.user || "unknown";
                                    const userName = userIdToName[userId] || userId;
                                    if (!channels[channelName].users[userName]) {
                                        channels[channelName].users[userName] = 0;
                                    }
                                    channels[channelName].users[userName]++;
                                    if (message.text && message.text.includes("merged")) {
                                        channels[channelName].mergedCount++;
                                    }
                                    if (message.text && message.text.includes("closed")) {
                                        channels[channelName].closedCount++;
                                    }
                                    if (message.reply_count && message.reply_count > 0) {
                                        channels[channelName].reflectionCount++;
                                    }
                                });
                            });
                            promises.push(promise);
                        }
                    });

                    Promise.all(promises).then(() => {
                        const tbody = document.getElementById('dataTable').querySelector('tbody');
                        const accordion = document.getElementById('accordion');
                        Object.keys(channels).forEach((channelName, index) => {
                            const channel = channels[channelName];
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${channelName}</td>
                                <td>${channel.messageCount}</td>
                                <td>${JSON.stringify(channel.users)}</td>
                                <td>${channel.mergedCount}</td>
                                <td>${channel.closedCount}</td>
                                <td>${channel.reflectionCount}</td>
                            `;
                            tbody.appendChild(row);

                            const logsHtml = channel.logs.map(log => `
                                <h6>File: ${log.file}</h6>
                                <pre>${JSON.stringify(log.content, null, 2)}</pre>
                            `).join('');
                            
                            const accordionItem = document.createElement('div');
                            accordionItem.classList.add('accordion-item');
                            accordionItem.innerHTML = `
                                <h2 class="accordion-header" id="heading${index}">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${index}" aria-expanded="false" aria-controls="collapse${index}">
                                        ${channelName}
                                    </button>
                                </h2>
                                <div id="collapse${index}" class="accordion-collapse collapse" aria-labelledby="heading${index}" data-bs-parent="#accordion">
                                    <div class="accordion-body">
                                        ${logsHtml}
                                    </div>
                                </div>
                            `;
                            accordion.appendChild(accordionItem);
                        });
                    });
                });
            }
        });
    </script>
</body>
</html>
